# Aegis 产品使用手册（面向运维）

版本：v1.0  
适用读者：负责 Todo_List 项目运维的 SRE / 运维工程师 / 开发同学

---

## 1. Aegis 是什么？

Aegis 是 Todo_List 项目的智能运维助手，可以理解为“会用 Prometheus 和 Loki 的大模型助手”。

你只需要用自然语言描述问题（中文即可），Aegis 会自动：

- 构造 PromQL / LogQL 查询；
- 访问 Prometheus / Loki；
- 综合指标与日志，给出运维结论与建议。

Aegis 提供三大核心功能（在前端对应三个页面）：

1. **ChatOps**：日常运维问答。
2. **RCA**：故障根因分析。
3. **Predict**：未来故障风险预测。

---

## 2. 前置条件

在使用 Aegis 前，请确认：

1. Todo_List 项目已部署在集群中。
2. 集群已经接入 Prometheus 和 Loki：
   - Prometheus 采集了 Todo_List 的服务指标、节点指标、MySQL 指标等；
   - Loki 采集了 Todo_List 的容器日志。
3. 你可以通过浏览器访问 Aegis 前端（通常是一个域名或端口），例如：
   - `http://aegis-frontend.example.com`

---

## 3. 快速上手

进入 Aegis 前端后，你会看到三个入口：

- ChatOps
- RCA
- Predict

可以通过顶部导航或侧边栏在三个页面间切换。

### 3.1 通用界面元素说明

在三个页面中都能看到的常见区域：

- **输入区域**：填写问题、时间范围、服务名等。
- **结果区域**：展示 Aegis 的分析结果（文字说明和结构化数据）。
- **Trace / 工具轨迹**（可折叠）：展示本次分析过程中调用了哪些工具、使用了什么查询。
- **LogQL / PromQL 展示**：在需要时会显示关键的 LogQL/PromQL 语句方便复制到 Loki/Prometheus 控制台。

---

## 4. ChatOps 使用指南

### 4.1 功能定位

ChatOps 适合用来做 **“即时运维问答”**，例如：

- “最近 30 分钟 ai-service 的错误率情况？”
- “todo-service 的 P95 延迟有没有异常？”
- “MySQL 现在是否健康？”

### 4.2 如何发起一次 ChatOps 查询

1. 打开 **ChatOps** 页面。
2. 在“问题”输入框中输入你的问题，例如：
   - `最近 30 分钟 user-service 的登录失败率有没有明显增加？`
3. 选择时间范围：
   - 可以直接选择“最近 30 分钟 / 1 小时”等快捷选项；
   - 或指定起止时间（精确到分钟即可）。
4. 可选：填写“会话 ID”：
   - 使用同一个 ID 可以让对话具备上下文记忆，适合多轮追问。
5. 点击“提交”或“查询”按钮。

### 4.3 如何解读结果

ChatOps 返回大致包含：

- **答案（Answer）**：Aegis 的自然语言回答。
- **时间范围**：本次分析实际使用的时间窗口。
- **使用的 LogQL**：
  - 这通常是一条关键日志查询语句，例如：  
    `{namespace="todo-demo", app="ai-service"} |~ "(?i)error|exception|failed"`
  - 你可以复制到 Loki 控制台进行二次深入分析。
- **Trace（轨迹）**：
  - 以步骤列表的形式展示：
    - 使用了哪些工具（Prometheus / Loki）；
    - 传入了什么参数；
    - 工具返回了什么。

如果返回中出现：

- `error: "invalid_datetime"`：说明 Agent 生成的时间格式不合法；
- `error: "prometheus_request_failed"`：说明 Prometheus 调用失败（如网络或地址问题）。

这时回答中通常会提示原因，你也可以根据 Trace 中的错误信息与平台配置进行排查。

---

## 5. RCA 使用指南

### 5.1 功能定位

RCA（Root Cause Analysis）适用于 **“已经发生的故障”** 场景，目标是：

- 帮你快速梳理：
  - 哪个服务最可疑？
  - 直接导致故障的根因是什么？
  - 有哪些关键证据？
  - 下一步应该怎么做？

### 5.2 如何发起一次 RCA 分析

1. 打开 **RCA** 页面。
2. 在“故障描述”文本框中填写尽量详细的信息，例如：

   > 10:00~10:15 间用户反馈登录频繁失败，user-service 返回 401/403 较多，请分析原因。

3. 选择故障发生的时间范围（必须提供起止时间）。
4. 可选：填写“会话 ID”，便于对同一次事故多轮深挖时保持上下文。
5. 点击“开始分析”。

### 5.3 如何解读 RCA 结果

RCA 的结果通常包含以下部分：

- **故障摘要（summary）**：
  - 对故障现象和根因的自然语言总结。
- **疑似服务（suspected_service）**：
  - 比如 `user-service` / `todo-service` / `ai-service`。
- **根因描述（root_cause）**：
  - 用简洁的语言说明导致故障的直接原因。
- **关键证据（evidence）**：
  - 条目列表，通常包含：
    - 某时间段指标突变；
    - 典型错误日志片段。
- **建议行动（suggested_actions）**：
  - 若干条可执行建议，供你作为排查或修复步骤参考。
- **Trace 轨迹**：
  - 展示 `rca_collect_evidence` 如何从多服务拉取日志、使用了哪些错误关键字等等。

> 提示：RCA 的输出是大模型基于监控数据的“推理结果”，仍然需要人工复核后再执行变更。

---

## 6. Predict 使用指南

### 6.1 功能定位

Predict 适用于 **“未来风险评估”** 场景，例如：

- 在高峰期前评估 ai-service 的风险。
- 在大版本发布后观察 todo-service 短期风险是否上升。

### 6.2 如何发起风险预测

1. 打开 **Predict** 页面。
2. 在“服务名”下拉框或输入框中填入需要评估的服务，例如：
   - `user-service`
   - `todo-service`
   - `ai-service`
3. 选择“回看小时数”（lookback_hours）：
   - 例如 24 小时（建议 12~48 小时之间）。
4. 可选：填写“会话 ID”。
5. 点击“开始预测”。

### 6.3 如何解读预测结果

预测结果包含：

- **service_name**：目标服务名。
- **risk_score（0.0~1.0）**：
  - 数值越接近 1 风险越高。
  - 这是大模型基于指标与日志综合评估的主观概率，并非精确统计。
- **risk_level**：
  - 如：
    - `low`：低风险，可保持观察。
    - `medium`：中等风险，建议关注、加强监控。
    - `high`：高风险，建议尽快排查或采取防御措施。
- **likely_failures**：
  - 列表形式，描述未来可能出现的故障类型。
- **explanation**：
  - 简短中文说明，概括主要依据（例如错误日志密度上升、P95 延迟抬升等）。
- **Trace**：
  - 显示本次预测调用了哪些指标和日志工具。

使用建议：

- 当 `risk_level` 为 `high` 时：
  - 建议提前查看 RCA 或 ChatOps 分析；
  - 评估是否推迟变更、扩容或增加保护机制。
- 当 `risk_level` 为 `medium` 且趋势上升时：
  - 建议缩短监控周期，密切观察变化。

---

## 7. 常见问题（FAQ）

### 7.1 为什么有时回答会说“查不到指标/日志”？

可能原因：

- Todo_List 项目尚未暴露对应指标；
- Prometheus 未采集该指标或写错了指标名；
- Loki 中没有对应时间段或服务的日志。

建议：

- 对照 Todo_List 项目的监控接入文档，确认指标/日志已正确暴露。
- 在 Prometheus/Loki 控制台中手动验证。

### 7.2 为什么会看到工具返回 `invalid_datetime`？

原因：

- 大模型在构造 `prometheus_query_range` 参数时生成了不符合 ISO8601 的时间字符串。

影响：

- Aegis 会在 Trace 中以结构化错误对象返回该错误，并在回答中提示。

建议：

- 如频繁出现，可将实际时间范围提示写得更明确（例如给出具体时间）；
- 或在后续版本中进一步收紧 Prompt 对时间格式的约束。

### 7.3 Aegis 是否会执行实际变更操作？

当前不会。Aegis 只提供分析与建议，不会：

- 自动重启服务；
- 自动扩容或缩容；
- 更改配置或数据库。

所有操作建议需要由人工在其它平台上执行。

---

## 8. 最佳实践与使用建议

1. **ChatOps 用于“问现在”**：
   - 日常巡检、查看当前状态、验证告警。
2. **RCA 用于“查刚才”**：
   - 对已经发生的告警或用户投诉，输入相应时间窗口进行根因分析。
3. **Predict 用于“看未来”**：
   - 在高峰前、变更前使用，用于提前发现潜在风险。
4. **多轮对话时使用 session_id**：
   - 对同一事件/主题的多次提问，建议带上统一的 session_id，以便 Aegis 记住上下文。
5. **善用 Trace**：
   - 当你对 Aegis 的结论有疑问时，打开 Trace 查看它实际查询了什么，再用 Prometheus/Loki 控制台进行交叉验证。

---

## 9. 获取支持

如在使用 Aegis 时遇到问题或有改进建议，建议：

- 在内部沟通渠道中联系 Aegis 项目维护者；
- 提供尽量完整的信息：请求参数、返回结果、Trace 内容以及预期行为。

这样可以帮助我们快速定位问题并持续改进 Aegis 的智能程度与稳定性。

