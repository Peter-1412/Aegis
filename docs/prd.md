# Aegis 产品需求文档（PRD）

版本：v1.0  
适用范围：面向 Todo_List 项目的智能运维助手 Aegis

---

## 1. 背景与目标

### 1.1 背景

在 Todo_List 项目中，已经接入了 Prometheus 和 Loki，对服务、节点、数据库提供了丰富的指标与日志。
但是传统的运维方式仍然依赖人工在多处控制台中手动构造 PromQL/LogQL、排查日志、交叉比对指标，
效率低、门槛高、知识难以沉淀。

大模型 LLM 的能力为“自动写查询语句、解释结果”提供了可能，因此希望建设一套围绕 Todo_List 项目的
智能运维助手 Aegis，实现“用自然语言进行运维”的体验。

### 1.2 产品目标

- 降低运维门槛：只需描述问题，不需要记忆 PromQL / LogQL 细节。
- 提升排障效率：将“查指标 + 看日志 + 总结结论”的过程自动化。
- 沉淀运维知识：通过可回放的 Trace 记录 Agent 的思考与操作路径。
- 支持决策：利用历史数据推断未来风险，辅助容量规划与变更决策。

### 1.3 不在本期范围

- 不做变更执行（如自动重启、自动扩容），仅提供分析与建议。
- 不实现多租户、复杂 RBAC 体系，仅面向单集群的运维团队。
- 不直接改造 Todo_List 业务代码，只通过指标和日志观测。

---

## 2. 用户与场景

### 2.1 用户角色

1. **一线 SRE / 运维工程师**
   - 主要使用 ChatOps 与 RCA 功能。
   - 在值班、故障处理和日常巡检中高频使用。

2. **高级 SRE / 架构师**
   - 同样使用 ChatOps 与 RCA，同时关注 Predict 结果，用于风险评估与容量规划。

3. **开发工程师**
   - 在自助排查功能问题时使用 ChatOps/RCA。
   - 通过预测结果评估新版本发布后的风险趋势。

### 2.2 典型使用场景

1. **日常运维问答（ChatOps）**
   - “最近 30 分钟 ai-service 是否有 5xx 峰值？”
   - “user-service 登录成功率最近一小时的变化情况如何？”

2. **故障处置（RCA）**
   - 已知时间窗口内出现大量 5xx/超时，SRE 将告警信息与时间范围输入 Aegis，
     期望得到“疑似服务 + 根因描述 + 关键证据 + 操作建议”。

3. **风险预测（Predict）**
   - 变更前：评估 `todo-service` 未来几小时的风险，决定是否在高峰前发布。
   - 定期巡检：生成关键服务的风险报告，提前暴露潜在故障模式。

---

## 3. 功能需求

### 3.1 ChatOps 功能

**3.1.1 功能描述**

- 用户在前端输入自然语言问题及时间范围，系统返回：
  - 运维视角的直接回答（中文）
  - 关键使用的 LogQL
  - 时间范围
  - 工具调用轨迹（供高级用户查看）

**3.1.2 详细需求**

1. 支持 `question + time_range + session_id` 三个字段：
   - `question`：必填。
   - `time_range`：可为 `start/end` 或 `last_minutes`。
   - `session_id`：可选，用于多轮对话。
2. Agent 必须优先使用：
   - Prometheus 做健康检查和宏观趋势分析；
   - Loki 做详细错误日志与行为日志分析。
3. 系统应显示最近一次分析使用的关键 LogQL，便于用户复制粘贴到 Loki 控制台。
4. 输出要求简洁、自洽、面向工程师，可直接指导下一步操作。

### 3.2 RCA 功能

**3.2.1 功能描述**

针对一次已知的故障事件，用户提供故障描述与时间范围，系统返回：

- 故障摘要（summary）
- 疑似服务（suspected_service）
- 根因描述（root_cause）
- 关键证据列表（evidence）
- 建议行动列表（suggested_actions）

**3.2.2 详细需求**

1. 必须支持从多个服务批量收集错误/异常相关日志：
   - 通过 `service_patterns` 聚焦服务名片段；
   - 通过 `text_patterns` 聚焦日志内容关键词。
2. 必须结合 Prometheus 指标（错误率、延迟、业务指标）与日志证据给出结论。
3. 输出的 `evidence` 应能直接引用到日志/指标中的具体片段（方便人类复核）。
4. 支持通过 session_id 暂存 RCA 多轮对话。

### 3.3 Predict 功能

**3.3.1 功能描述**

用户选择一个服务及回看小时数，系统结合历史错误日志与关键指标，输出：

- `risk_score`：0~1 风险分（主观概率）
- `risk_level`：风险等级（low / medium / high）
- `likely_failures`：未来可能出现的故障类型列表
- `explanation`：风险判断依据的中文说明

**3.3.2 详细需求**

1. Agent 必须主动调用：
   - Prometheus：请求量、错误率、P95/P99 延迟、关键业务指标；
   - Loki：错误日志计数时间序列与代表性错误样本。
2. 风险分 `risk_score` 由大模型综合判断，内置算法仅作为兜底，不是主导逻辑。
3. 风险等级与分数应保持一致性，提升可解释性。
4. 需支持 session_id，用于连续多次预测时共享上下文。

### 3.4 前端控制台

**3.4.1 统一入口**

提供单页应用，包含三个子页面：

- ChatOps 页面
- RCA 页面
- Predict 页面

**3.4.2 展示与交互**

每个页面至少提供：

- 请求参数表单（文本输入 / 时间选择 / 下拉选择服务等）
- 结果展示区（回答 / 分析结果）
- 工具调用轨迹（可折叠）
- 关键 LogQL / LogQL 的复制功能

---

## 4. 非功能需求

### 4.1 性能

- 单次请求（不涉及超长时间范围）应在 **5~10 秒** 内返回结果（取决于 LLM 时延）。
- 对于长时间窗口（>24h）的查询，允许相对较长的等待时间，但需要在前端有 Loading 提示。

### 4.2 可用性

- 即使 Prometheus/Loki/LLM 任一不可用，系统也应返回有信息量的错误提示，而非直接 500。
- 对工具调用异常要做错误封装，避免未捕获异常导致接口挂掉。

### 4.3 可观测性

- 后端服务应输出结构化日志，便于自身被 Loki 监控。
- 关键路径（调用 LLM、Loki、Prometheus）的错误要有明确日志与统计。

### 4.4 安全性

- 当前示例环境未开启鉴权，真实生产环境应通过网关增加认证鉴权。
- 不在 Agent Prompt 中暴露敏感凭据或内部实现细节。

---

## 5. 业务流程（高层）

### 5.1 ChatOps 流程

1. 用户在前端 ChatOps 页面输入问题与时间范围。
2. 前端调用 ChatOps Service `/api/chatops/query`。
3. ChatOps Agent：
   - 解析问题，决定调用 Prometheus/Loki 的方式；
   - 分多步调用工具（前置 trace_note）；
   - 综合结果生成回答。
4. 后端返回回答 + LogQL + Trace，前端展示。

### 5.2 RCA 流程

1. 用户输入故障描述与时间窗口。
2. 前端调用 `/api/rca/analyze`。
3. RCA Agent：
   - 结合症状与时间窗口，查询关键指标；
   - 调用 `rca_collect_evidence` 批量收集错误日志；
   - 形成根因假设、挑选证据、输出结构化 JSON。
4. 前端展示 RCA 报告和 Trace。

### 5.3 Predict 流程

1. 用户选择服务与回看窗口。
2. 前端调用 `/api/predict/run`。
3. Predict Agent：
   - 查询指标与错误日志特征；
   - 大模型综合判断风险分与可能故障类型；
   - 返回结构化结果。
4. 前端以卡片或图表方式展示。

---

## 6. 依赖与约束

- 必须有可用的 Prometheus 与 Loki 实例，并正确采集 Todo_List 的指标与日志。
- 指标与日志结构需与 `Todo_List/docs/monitoring_queries_agent.md` 约定保持一致。
- LLM 接入（目前为火山方舟 Ark）需要有效的密钥和网络连通性。

---

## 7. 版本规划（简要）

1. **v0.1**：基础三服务 + 前端最小可用 UI。
2. **v0.2**：接入 Prometheus 工具，支持指标查询。
3. **v0.3**：工具拆分为单文件、提升可维护性。
4. **v0.4**：统一命名空间与资源命名为 `aegis`。
5. **v0.5**：针对 Todo_List 场景优化 Prompt，Predict 改为 LLM 主导风险评估。
6. **v0.6**：修复 Prompt 花括号与 Prometheus 时间解析等问题，提升鲁棒性。

详细迭代记录见 [`docs/iterations.md`](iterations.md)。

